import os
import json
import logging

logger = logging.getLogger("live-notifier")

DATA_FILE = "data/streamers.json"


def load_streamers():
    os.makedirs("data", exist_ok=True)

    if not os.path.exists(DATA_FILE):
        return {"guilds": {}}

    try:
        with open(DATA_FILE, "r", encoding="utf-8") as f:
            content = f.read().strip()

            if not content:
                logger.warning("streamers.json is empty. Resetting.")
                return {"guilds": {}}

            return json.loads(content)

    except json.JSONDecodeError as e:
        logger.error("Corrupted streamers.json detected: %s", e)

        # Backup corrupted file
        try:
            os.rename(DATA_FILE, DATA_FILE + ".corrupted")
        except Exception:
            pass

        return {"guilds": {}}

    except Exception as e:
        logger.error("Failed to load streamers.json: %s", e)
        return {"guilds": {}}


def save_streamers(data):
    os.makedirs("data", exist_ok=True)

    temp_file = DATA_FILE + ".tmp"

    try:
        # Write to temp file first
        with open(temp_file, "w", encoding="utf-8") as f:
            json.dump(data, f, indent=2)

        # Atomic replace
        os.replace(temp_file, DATA_FILE)

    except Exception as e:
        logger.error("Failed to save streamers.json safely: %s", e)
